<!-- Generated by Doxygen 1.8.15 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">FIFO read<div class="ingroups"><a class="el" href="group__bma400.html">BMA400</a> &raquo; <a class="el" href="group__bma400_examples.html">Examples</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p>Read and extract FIFO data. </p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Copyright (C) 2019 Bosch Sensortec GmbH</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * License is available in the root folder</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;bma400.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;bma400_hal_custom.h&quot;</span></div><div class="line"></div><div class="line"><span class="comment">/* Earth&#39;s gravity in m/s^2 */</span></div><div class="line"><span class="preprocessor">#define GRAVITY_EARTH    (9.80665f)</span></div><div class="line"></div><div class="line"><span class="comment">/* 39.0625us per tick */</span></div><div class="line"><span class="preprocessor">#define SENSOR_TICK_TO_S (0.0000390625f)</span></div><div class="line"></div><div class="line"><span class="comment">/* Include 2 additional frames to account for</span></div><div class="line"><span class="comment"> * the next frame already being in the FIFO</span></div><div class="line"><span class="comment"> * and the sensor time frame</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#define N_FRAMES         50</span></div><div class="line"></div><div class="line"><span class="comment">/* 50 Frames result in 50*7, 350 bytes.</span></div><div class="line"><span class="comment"> * A few extra for the sensor time frame and</span></div><div class="line"><span class="comment"> * in case the next frame is available too.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#define FIFO_SIZE        (357 + BMA400_FIFO_BYTES_OVERREAD)</span></div><div class="line"></div><div class="line"><span class="comment">/* Delay to fill FIFO data At ODR of say 100 Hz,</span></div><div class="line"><span class="comment"> * 1 frame gets updated in 1/100 = 0.01s i.e. for</span></div><div class="line"><span class="comment"> * 50 frames we need 50 * 0.01 =  0.5 seconds delay</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#define WAIT_PERIOD_MS   500</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> print_rslt(int8_t rslt);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">float</span> lsb_to_ms2(int16_t accel_data, uint8_t g_range, uint8_t bit_width);</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> <span class="keyword">const</span> *argv[])</div><div class="line">{</div><div class="line">    <span class="keyword">struct </span>bma400_dev bma;</div><div class="line">    <span class="keyword">struct </span>bma400_sensor_data accel_data[N_FRAMES] = { 0 };</div><div class="line">    <span class="keyword">struct </span>bma400_fifo_data fifo_frame;</div><div class="line">    <span class="keyword">struct </span>bma400_device_conf fifo_conf;</div><div class="line">    <span class="keyword">struct </span>bma400_sensor_conf conf;</div><div class="line">    int8_t rslt;</div><div class="line">    uint16_t i;</div><div class="line">    uint8_t fifo_buff[FIFO_SIZE] = { 0 };</div><div class="line">    uint16_t accel_frames_req = N_FRAMES;</div><div class="line">    <span class="keywordtype">float</span> x, y, z, t;</div><div class="line">    uint8_t n = 20; <span class="comment">/* Read the FIFO 20 times */</span></div><div class="line"></div><div class="line">    bma400_example_hal_init();</div><div class="line"></div><div class="line">    <span class="comment">/* Bus configuration : I2C*/</span></div><div class="line">    bma.dev_id = BMA400_I2C_ADDRESS_SDO_LOW;</div><div class="line">    bma.intf = BMA400_I2C_INTF;</div><div class="line"></div><div class="line">    <span class="comment">/* For SPI un-comment following code */</span></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * bma.dev_id = 0; //  Could be used to identify the chip select line</span></div><div class="line"><span class="comment">     * bma.intf = BMA400_SPI_INTF;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    bma.delay_ms = bma400_example_hal_delay_ms;</div><div class="line">    bma.read = bma400_example_hal_bus_read;</div><div class="line">    bma.write = bma400_example_hal_bus_write;</div><div class="line"></div><div class="line">    rslt = bma400_init(&amp;bma);</div><div class="line">    print_rslt(rslt);</div><div class="line"></div><div class="line">    rslt = bma400_soft_reset(&amp;bma);</div><div class="line">    print_rslt(rslt);</div><div class="line"></div><div class="line">    <span class="comment">/* Select the type of configuration to be modified */</span></div><div class="line">    conf.type = BMA400_ACCEL;</div><div class="line"></div><div class="line">    <span class="comment">/* Get the accelerometer configurations which are set in the sensor */</span></div><div class="line">    rslt = bma400_get_sensor_conf(&amp;conf, 1, &amp;bma);</div><div class="line">    print_rslt(rslt);</div><div class="line"></div><div class="line">    <span class="comment">/* Modify the desired configurations as per macros</span></div><div class="line"><span class="comment">     * available in bma400_defs.h file */</span></div><div class="line">    conf.param.accel.odr = BMA400_ODR_100HZ;</div><div class="line">    conf.param.accel.range = BMA400_2G_RANGE;</div><div class="line">    conf.param.accel.data_src = BMA400_DATA_SRC_ACCEL_FILT_1;</div><div class="line"></div><div class="line">    <span class="comment">/* Set the desired configurations to the sensor */</span></div><div class="line">    rslt = bma400_set_sensor_conf(&amp;conf, 1, &amp;bma);</div><div class="line">    print_rslt(rslt);</div><div class="line"></div><div class="line">    fifo_conf.type = BMA400_FIFO_CONF;</div><div class="line"></div><div class="line">    rslt = bma400_get_device_conf(&amp;fifo_conf, 1, &amp;bma);</div><div class="line">    print_rslt(rslt);</div><div class="line"></div><div class="line">    fifo_conf.param.fifo_conf.conf_regs = BMA400_FIFO_X_EN | BMA400_FIFO_Y_EN | BMA400_FIFO_Z_EN | BMA400_FIFO_TIME_EN;</div><div class="line">    fifo_conf.param.fifo_conf.conf_status = BMA400_ENABLE;</div><div class="line"></div><div class="line">    rslt = bma400_set_device_conf(&amp;fifo_conf, 1, &amp;bma);</div><div class="line">    print_rslt(rslt);</div><div class="line"></div><div class="line">    rslt = bma400_set_power_mode(BMA400_NORMAL_MODE, &amp;bma);</div><div class="line">    print_rslt(rslt);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> ((rslt == BMA400_OK) &amp;&amp; n)</div><div class="line">    {</div><div class="line">        fifo_frame.data = fifo_buff;</div><div class="line">        fifo_frame.length = FIFO_SIZE;</div><div class="line">        bma.delay_ms(WAIT_PERIOD_MS);</div><div class="line"></div><div class="line">        printf(<span class="stringliteral">&quot;Requested FIFO length : %d\r\n&quot;</span>, fifo_frame.length);</div><div class="line"></div><div class="line">        rslt = bma400_get_fifo_data(&amp;fifo_frame, &amp;bma);</div><div class="line">        print_rslt(rslt);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (rslt != BMA400_OK)</div><div class="line">        {</div><div class="line">            printf(<span class="stringliteral">&quot;FIFO read failed\r\n&quot;</span>);</div><div class="line">        }</div><div class="line"></div><div class="line">        printf(<span class="stringliteral">&quot;Available FIFO length : %d \r\n&quot;</span>, fifo_frame.length);</div><div class="line"></div><div class="line">        <span class="keywordflow">do</span></div><div class="line">        {</div><div class="line">            accel_frames_req = N_FRAMES;</div><div class="line">            rslt = bma400_extract_accel(&amp;fifo_frame, accel_data, &amp;accel_frames_req, &amp;bma);</div><div class="line">            print_rslt(rslt);</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (rslt != BMA400_OK)</div><div class="line">            {</div><div class="line">                printf(<span class="stringliteral">&quot;Accelerometer data extraction failed\r\n&quot;</span>);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (accel_frames_req)</div><div class="line">            {</div><div class="line">                printf(<span class="stringliteral">&quot;Extracted FIFO frames : %d \r\n&quot;</span>, accel_frames_req);</div><div class="line"></div><div class="line">                printf(<span class="stringliteral">&quot;Frame index, Ax[m/s2], Ay[m/s2], Az[m/s2]\r\n&quot;</span>);</div><div class="line">                <span class="keywordflow">for</span> (i = 0; i &lt; accel_frames_req; i++)</div><div class="line">                {</div><div class="line">                    bma.delay_ms(10); <span class="comment">/* Wait for 10ms as ODR is set to 100Hz */</span></div><div class="line"></div><div class="line">                    <span class="comment">/* 12-bit accelerometer at range 2G */</span></div><div class="line">                    x = lsb_to_ms2(accel_data[i].x, 2, 12);</div><div class="line">                    y = lsb_to_ms2(accel_data[i].y, 2, 12);</div><div class="line">                    z = lsb_to_ms2(accel_data[i].z, 2, 12);</div><div class="line"></div><div class="line">                    printf(<span class="stringliteral">&quot;%d, %.2f, %.2f, %.2f\r\n&quot;</span>, i, x, y, z);</div><div class="line">                }</div><div class="line">            }</div><div class="line">        } <span class="keywordflow">while</span> (accel_frames_req);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (fifo_frame.fifo_sensor_time)</div><div class="line">        {</div><div class="line">            t = (float)fifo_frame.fifo_sensor_time * SENSOR_TICK_TO_S;</div><div class="line"></div><div class="line">            printf(<span class="stringliteral">&quot;FIFO sensor time : %.4fs\r\n&quot;</span>, t);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (fifo_frame.conf_change)</div><div class="line">        {</div><div class="line">            printf(<span class="stringliteral">&quot;FIFO configuration change: 0x%X\r\n&quot;</span>, fifo_frame.conf_change);</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (fifo_frame.conf_change &amp; BMA400_FIFO_CONF0_CHANGE)</div><div class="line">            {</div><div class="line">                printf(<span class="stringliteral">&quot;FIFO data source configuration changed \r\n&quot;</span>);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (fifo_frame.conf_change &amp; BMA400_ACCEL_CONF0_CHANGE)</div><div class="line">            {</div><div class="line">                printf(<span class="stringliteral">&quot;Accel filt1_bw configuration changed \r\n&quot;</span>);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (fifo_frame.conf_change &amp; BMA400_ACCEL_CONF1_CHANGE)</div><div class="line">            {</div><div class="line">                printf(<span class="stringliteral">&quot;Accel odr/osr/range configuration changed \r\n&quot;</span>);</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        n--;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> print_rslt(int8_t rslt)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (rslt)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> BMA400_OK:</div><div class="line"></div><div class="line">            <span class="comment">/* Do nothing */</span></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> BMA400_E_NULL_PTR:</div><div class="line">            printf(<span class="stringliteral">&quot;Error [%d] : Null pointer\r\n&quot;</span>, rslt);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> BMA400_E_COM_FAIL:</div><div class="line">            printf(<span class="stringliteral">&quot;Error [%d] : Communication failure\r\n&quot;</span>, rslt);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> BMA400_E_DEV_NOT_FOUND:</div><div class="line">            printf(<span class="stringliteral">&quot;Error [%d] : Device not found\r\n&quot;</span>, rslt);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> BMA400_E_INVALID_CONFIG:</div><div class="line">            printf(<span class="stringliteral">&quot;Error [%d] : Invalid configuration\r\n&quot;</span>, rslt);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> BMA400_W_SELF_TEST_FAIL:</div><div class="line">            printf(<span class="stringliteral">&quot;Warning [%d] : Self test failed\r\n&quot;</span>, rslt);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            printf(<span class="stringliteral">&quot;Error [%d] : Unknown error code\r\n&quot;</span>, rslt);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">float</span> lsb_to_ms2(int16_t accel_data, uint8_t g_range, uint8_t bit_width)</div><div class="line">{</div><div class="line">    <span class="keywordtype">float</span> accel_ms2;</div><div class="line">    int16_t half_scale;</div><div class="line"></div><div class="line">    half_scale = 1 &lt;&lt; (bit_width - 1);</div><div class="line">    accel_ms2 = (GRAVITY_EARTH * accel_data * g_range) / half_scale;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> accel_ms2;</div><div class="line"></div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
